---
- name: Containerd modules load
  template:
    src: containerd.conf.j2
    dest: /etc/modules-load.d/containerd.conf

- name: Modprobe overlay 
  command: modprobe overlay

- name: Modprobe br_netfilter
  command: modprobe br_netfilter

- name: Kernel parameters for Kubernetes
  template:
    src: kubernetes.conf.j2
    dest: /etc/sysctl.d/99-kubernetes-cri.conf

- name: Reload systemctl
  command: sysctl --system

- name: Refresh apt update
  command: "apt-get update -y"

- name: Install Containerd
  apt: 
    name: '{{item}}'
    state: present
  with_items:
  - containerd

- name: Create Folder containerd
  shell: "mkdir -p /etc/containerd"

- name: Config containerd
  command: "sudo containerd config default | sudo tee /etc/containerd/config.toml"

- name: Restart containerd service
  service:
    name: containerd
    state: restarted

- name: Enable service containerd state
  service:
    name: containerd
    enabled: true

- name: Swapp off 
  command: swapoff -a

- name: Comment swap /etc/fstab
  command: sed -i '/\/swap/ s/^\(.*\)$/#\1/g' /etc/fstab

- name: Install pre-requisites
  apt: 
    name: '{{item}}'
    state: present
  with_items:
  - curl
  - apt-transport-https

- name: Add apt repository for Kubernetes
  shell: "curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -"

- name: Repo parameters for Kubernetes
  shell: "echo \"deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main\" | sudo tee /etc/apt/sources.list.d/kubernetes.list"

- name: Refresh apt update
  command: "apt-get update -y"

- name: Install Kubernetes
  apt: 
    name: '{{item}}'
    state: present
  with_items:
  - kubelet=1.24.0-00
  - kubeadm=1.24.0-00
  - kubectl=1.24.0-00

- name: Prevent kubectl, kubeadm, and kubelet from being upgraded
  dpkg_selections:
    name: '{{item}}'
    selection: hold
  with_items:
  - kubelet
  - kubeadm
  - kubectl

